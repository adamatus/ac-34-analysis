<!DOCTYPE html>
<html>
  <head>
    <title>America's Cup 34 Race Analyzer</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
#map { height: 400px; }

.mark {
    fill: yellow;
    stroke: none;
}

.boat-marker {
    opacity: 1;
    stroke: none;
    fill: black;
}

.boat-marker-usa {
    fill: black;
}

.boat-marker-nzl {
    fill: red;
}

.boat-marker-heli {
    fill: blue;
}

.boat-marker-ump {
    fill: yellow;
}

.boat-marker-cam {
    fill: green;
}

.boat-marker-rc {
    fill: white;
}

.boat-marker-marshall {
    fill: gray;
}

.track {
    opacity: 1;
    stroke: black;
    stroke-width: 1px;
    fill: none;
}

.track-usa {
    stroke: black;
}

.track-nzl {
    stroke: red;
}

.track-heli {
    stroke: blue;
}

.track-ump {
    stroke: yellow;
}

.track-cam {
    stroke: green;
}

.track-rc {
    stroke: white;
}

.track-marshall {
    stroke: gray;
}
    </style>
  </head>
  <body>
      <div id="map"></div>
      <script>
var map = L.map('map').setView([37.82022604148547, -122.4294090270996], 13);
L.tileLayer('http://{s}.tile.cloudmade.com/78f159c3ec8c4290b7854cf0471003ec/997/256/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://cloudmade.com">CloudMade</a>',
    maxZoom: 18
}).addTo(map);

map._initPathRoot() 

var svg = d3.select("#map").select("svg"),
    g = svg.append("g").attr('id','#d3-layer');

function project(x) {
  return map.latLngToLayerPoint(new L.LatLng(x.lat, x.lon));
}

var track = d3.svg.line()
    .x(function(d) { return d.x })
    .y(function(d) { return d.y });

var marks = [{lat:37.820190,lon:-122.456763,label:'Entry'},
             {lat:37.81705,lon:-122.455,label:'Start Gate (Stb)'},
             {lat:37.81746,lon:-122.4519,label:'Start Gate (Port)'},
             {lat:37.81284,lon:-122.4505,label:'Mark 1 (Port)'},
             {lat:37.82368,lon:-122.4008,label:'Leeward Gate (Port)'},
             {lat:37.82227,lon:-122.4004,label:'Leeward Gate (Stb)'},
             {lat:37.81286,lon:-122.4624,label:'Windward Gate (Stb)'},
             {lat:37.81437,lon:-122.4631,label:'Windward Gate (Port)'},
             {lat:37.81023,lon:-122.4012,label:'Finish Gate (Stb)'},
             {lat:37.81039,lon:-122.3993,label:'Finish Gate (Port)'}];


var markGroup = g.append('g').attr('id','mark-group');
markGroup.selectAll('.mark')
        .data(marks.map(function(d) { return project(d); }),function(d,i) { return i; })
    .enter().append('svg:circle')
        .attr('class','mark')
        .attr('r',2)
        .attr('cx',function(d) { return d.x; })
        .attr('cy',function(d) { return d.y; })
        .on('mouseout',function(d,i) { console.log(marks[i].label); });

var boatGroup = g.append('g').attr('id','boat-group');

var boats = [{id:'USA',className:'usa'},
             {id:'PRO',className:'rc'},
             {id:'HL1',className:'heli'},
             {id:'HL2',className:'heli'},
             {id:'RGR',className:'marshall'},
             {id:'SHA',className:'marshall'},
             {id:'U1',className:'ump'},
             {id:'U2',className:'ump'},
             {id:'U3',className:'ump'},
             {id:'VOL',className:'cam'},
             {id:'WEA',className:'cam'},
             {id:'NZL',className:'nzl'}];

var track_points = {};

// Each loaded CSV gets wrapped as a closure so arguments hold up
for (var i = 0; i < boats.length; i++) (function(i) {
    var boat_id = boats[i].id;
    var boat_class = boats[i].className;
    d3.csv('../data/130925/csv/20130925130025-NAV-'+boat_id+'.csv')
        .row(function(d) { 
            return {lat:d.Lat, lon:d.Lon}; })
        .get(function(error,rows) { 
          
            track_points[boat_id] = rows;  
            var boatTrack = boatGroup.append('svg:g')
                .attr('id','boat-group-'.concat(boat_id))
                .attr('class','boat-group');
            boatTrack.append('svg:path')
                    .attr("d",track(track_points[boat_id].map(function(d) { return project(d); })))
                    .attr('id','track-'.concat(boat_id))
                    .attr('class','track track-'.concat(boat_class));

            boatTrack.selectAll('.boat-marker')
                    .data([project(track_points[boat_id][0])])
                .enter().append('svg:circle')
                    .attr('id','boat-marker-'.concat(boat_id))
                    .attr('class','boat-marker boat-marker-'.concat(boat_class))
                    .attr('r',3)
                    .attr('cx',function(d) { return d.x; })
                    .attr('cy',function(d) { return d.y; });
         });
})(i);

var updateView = function() {
    // Update mark positions
    g.selectAll('.mark')
        .data(marks.map(function(d) { return project(d); }),function(d,i) { return i; })
        .attr('cx',function(d) { return d.x; })
        .attr('cy',function(d) { return d.y; });
    
    for (var i = 0; i < boats.length; i++) {
        var boat_id = boats[i].id;
        g.select('#track-'.concat(boat_id))
            .attr("d",track(track_points[boat_id].map(function(d) { return project(d); })))

        g.select('#boat-marker-'.concat(boat_id))
                .data([project(track_points[boat_id][0])])
            .attr('cx',function(d) { return d.x; })
            .attr('cy',function(d) { return d.y; });
    }


};

map.on("viewreset",updateView)
      </script>
  </body>
</html>

